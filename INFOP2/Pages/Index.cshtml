@page
@model IndexModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h2 class="fw-bold mb-1">@ViewData["Title"]</h2>
                    <p class="text-muted mb-0">Welcome to your dashboard</p>
                </div>
                <div class="text-end">
                    <h4 class="h6 mb-1">Welcome back,</h4>
                    <p class="text-primary mb-0 fw-bold">@User.Identity?.Name</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Summary Cards -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 p-3 rounded-3 me-3">
                                <i class="fas fa-users text-primary fa-lg"></i>
                            </div>
                            <h6 class="text-uppercase text-muted mb-0">Masterlist</h6>
                        </div>
                        <a href="/masterlist" class="text-decoration-none">
                            <i class="fas fa-arrow-right text-secondary"></i>
                        </a>
                    </div>
                    <h3 class="fw-bold mb-0" id="masterlist-count">Loading...</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 p-3 rounded-3 me-3">
                                <i class="fas fa-box text-success fa-lg"></i>
                            </div>
                            <h6 class="text-uppercase text-muted mb-0">Assetlist</h6>
                        </div>
                        <a href="/assetlist" class="text-decoration-none">
                            <i class="fas fa-arrow-right text-secondary"></i>
                        </a>
                    </div>
                    <h3 class="fw-bold mb-0" id="assetlist-count">Loading...</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-warning bg-opacity-10 p-3 rounded-3 me-3">
                                <i class="fas fa-money-bill text-warning fa-lg"></i>
                            </div>
                            <h6 class="text-uppercase text-muted mb-0">Finance</h6>
                        </div>
                        <a href="/finance" class="text-decoration-none">
                            <i class="fas fa-arrow-right text-secondary"></i>
                        </a>
                    </div>
                    <h3 class="fw-bold mb-0" id="finance-total">Loading...</h3>
                </div>
            </div>
        </div>

        <!-- Prayer Ministry -->
        <div class="col-md-12">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger bg-opacity-10 p-3 rounded-3 me-3">
                                <i class="fas fa-pray text-danger fa-lg"></i>
                            </div>
                            <h6 class="text-uppercase text-muted mb-0">Prayer Ministry</h6>
                        </div>
                        <a href="/prayerministry" class="text-decoration-none">
                            <i class="fas fa-arrow-right text-secondary"></i>
                        </a>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="fw-semibold">Title</th>
                                    <th class="fw-semibold">Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="prayer-ministry-list">
                                <tr>
                                    <td colspan="2" class="text-center text-muted">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule List -->
        <div class="col-md-12">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 p-3 rounded-3 me-3">
                                <i class="fas fa-calendar text-success fa-lg"></i>
                            </div>
                            <h6 class="text-uppercase text-muted mb-0">Schedules</h6>
                        </div>
                        <a href="/schedule" class="text-decoration-none">
                            <i class="fas fa-arrow-right text-secondary"></i>
                        </a>
                    </div>
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="fw-semibold">Event</th>
                                    <th class="fw-semibold">Details</th>
                                    <th class="fw-semibold">Date & Time</th>
                                    <th class="fw-semibold">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fw-medium">Sunday Worship</td>
                                    <td>
                                        <ul class="list-unstyled mb-0">
                                            <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span>Welcome & Opening Prayer</span>
                                                <span class="text-muted small">Music Ministry</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span>Praise & Worship</span>
                                                <span class="text-muted small">Pastor Mike Sample</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span>Offering/Giving</span>
                                                <span class="text-muted small">Jane Random</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center py-2">
                                                <span>Special Numbers</span>
                                                <span class="text-muted small">John Random</span>
                                            </li>
                                        </ul>
                                    </td>
                                    <td>
                                        <div class="fw-medium">April 13, 2025</div>
                                        <div class="text-muted small">10:00 AM</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">Upcoming</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-medium">Sunday Worship</td>
                                    <td>
                                        <ul class="list-unstyled mb-0">
                                            <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span>Welcome & Opening Prayer</span>
                                                <span class="text-muted small">Music Ministry</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span>Praise & Worship</span>
                                                <span class="text-muted small">Pastor Whisker McNom</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span>Offering/Giving</span>
                                                <span class="text-muted small">Chris Wilson</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center py-2">
                                                <span>Special Numbers</span>
                                                <span class="text-muted small">Anna Miller</span>
                                            </li>
                                        </ul>
                                    </td>
                                    <td>
                                        <div class="fw-medium">April 20, 2025</div>
                                        <div class="text-muted small">10:00 AM</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill">Ended</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Initialize Firebase
        let db = null;
        try {
            const firebaseConfig = @Html.Raw(Model.FirebaseConfigJson);
            console.log("Firebase Config:", firebaseConfig);
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                throw new Error("Firebase configuration is empty or invalid");
            }
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // Load dashboard data
        async function loadDashboardData() {
            if (!db) {
                console.error("Firestore db is not initialized");
                return;
            }

            try {
                // Load Masterlist count
                const masterlistSnapshot = await db.collection('people').get();
                document.getElementById('masterlist-count').textContent = masterlistSnapshot.size;

                // Load Assetlist count
                const assetlistSnapshot = await db.collection('assets').get();
                document.getElementById('assetlist-count').textContent = assetlistSnapshot.size;

                // Load Finance total
                const transactionsSnapshot = await db.collection('transactions').get();
                let totalAmount = 0;
                transactionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.Category === 'Income') {
                        totalAmount += data.Amount;
                    } else if (data.Category === 'Expense') {
                        totalAmount -= data.Amount;
                    }
                });
                document.getElementById('finance-total').textContent = `$${totalAmount.toLocaleString()}`;

                // Load Prayer Ministry titles
                const prayerSnapshot = await db.collection('prayer_events').get();
                const prayerList = document.getElementById('prayer-ministry-list');
                
                if (prayerSnapshot.empty) {
                    prayerList.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No prayer events found</td></tr>';
                } else {
                    prayerList.innerHTML = '';
                    prayerSnapshot.forEach(doc => {
                        const data = doc.data();
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.Title || ''}</td>
                            <td>${data.Remarks || ''}</td>
                        `;
                        prayerList.appendChild(row);
                    });
                }
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                document.getElementById('masterlist-count').textContent = 'Error';
                document.getElementById('assetlist-count').textContent = 'Error';
                document.getElementById('finance-total').textContent = 'Error';
                document.getElementById('prayer-ministry-list').innerHTML = '<tr><td colspan="2" class="text-center text-danger">Error loading prayer events</td></tr>';
            }
        }

        // Load data when page loads
        window.onload = function() {
            loadDashboardData();
        };
    </script>
}