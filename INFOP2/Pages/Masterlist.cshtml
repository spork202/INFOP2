@page
@model INFOP2.Pages.Masterlist
@{
    ViewData["Title"] = "Masterlist";
    Layout = "_Layout";
}

<style>
    /* Copy all button styling */
    .copy-all-btn {
        font-size: 14px;
    }
    /* Feedback message styling */
    .copy-feedback {
        position: absolute;
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .copy-feedback.show {
        opacity: 1;
    }
</style>

<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h2 class="fw-bold mb-1">@ViewData["Title"]</h2>
                    <p class="text-muted mb-0">Manage your people</p>
                </div>
                <div class="text-end">
                    <h4 class="h6 mb-1">Welcome back,</h4>
                    <p class="text-primary mb-0 fw-bold">@User.Identity?.Name</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Card -->
    <div id="success-card" class="card border-success shadow-sm mb-4 d-none">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title text-success mb-1">Success!</h5>
                <p class="card-text" id="success-message">Action completed successfully!</p>
            </div>
            <button type="button" class="btn-close" aria-label="Close" onclick="$('#success-card').addClass('d-none');"></button>
        </div>
    </div>
    
    <div class="row mb-4 g-3">
        <!-- Total People Card -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0 rounded-4 bg-gradient">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-container me-3 bg-primary bg-opacity-10 rounded-3 p-3">
                            <i class="fa-solid fa-users text-primary fa-xl"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="card-subtitle mb-1 text-muted small text-uppercase fw-semibold">Total People</h6>
                            <h4 class="card-title mb-0 fw-bold" id="total-people">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BS Families Card -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0 rounded-4 bg-gradient">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-container me-3 bg-success bg-opacity-10 rounded-3 p-3">
                            <i class="fa-solid fa-home text-success fa-xl"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="card-subtitle mb-1 text-muted small text-uppercase fw-semibold">BS Families</h6>
                            <h4 class="card-title mb-0 fw-bold" id="bs-families">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ministries Card -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0 rounded-4 bg-gradient">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-container me-3 bg-warning bg-opacity-10 rounded-3 p-3">
                            <i class="fa-solid fa-church text-warning fa-xl"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="card-subtitle mb-1 text-muted small text-uppercase fw-semibold">Ministries</h6>
                            <h4 class="card-title mb-0 fw-bold" id="ministries">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Add Button -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-6 mb-3 mb-md-0">
            <form id="search-form" method="get" class="d-flex">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fa-solid fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" placeholder="Search by name..." asp-for="SearchTerm" id="search-term" />
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>
        <div class="col-md-6 d-flex justify-content-end gap-2">
            <button id="add-btn" class="btn btn-success d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#addModal">
                <i class="fa-solid fa-plus me-2"></i> Add Person
            </button>
            <button class="btn btn-outline-secondary d-flex align-items-center" id="exportBtnMaster" data-bs-tooltip="tooltip" title="Export to Excel">
                <i class="fa-solid fa-download me-2"></i> Export
            </button>
            <button class="btn btn-outline-secondary d-flex align-items-center" id="importBtnMaster" data-bs-tooltip="tooltip" title="Import from Excel" data-bs-toggle="modal" data-bs-target="#importModal">
                <i class="fa-solid fa-upload me-2"></i> Import
            </button>
            <button class="btn btn-outline-secondary d-flex align-items-center copy-all-btn" onclick="copyAllData(this)" title="Copy all people data" aria-label="Copy all people data">
                <i class="fa-solid fa-copy me-2"></i> Copy All
            </button>
        </div>
    </div>

    <!-- Table Section -->
    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-semibold">People List</h5>
                <a href="#" class="text-primary small text-decoration-none">View More <i class="fa-solid fa-arrow-right ms-1"></i></a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr class="text-uppercase small text-muted">
                            <th class="ps-4">Name</th>
                            <th>Nickname</th>
                            <th>BS Family</th>
                            <th>Ministry</th>
                            <th>Contact No.</th>
                            <th>Birthdate</th>
                            <th>Country Address</th>
                            <th>KSA Address</th>
                            <th>Company</th>
                            <th>Job Position</th>
                            <th>1st Worship Date</th>
                            <th>Baptized Date</th>
                            <th>Remarks</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="person-table-body">
                    <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-4">
        <small class="text-muted" id="pagination-info"></small>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <!-- Dynamically populated -->
            </ul>
        </nav>
    </div>

    <!-- No Data -->
    <div id="no-data" class="text-center mt-5 d-none">
        <div class="py-5">
            <i class="fa-solid fa-users fa-3x text-muted mb-3"></i>
            <p class="text-muted mb-0">No people in the list. Click "Add Person" to start.</p>
        </div>
    </div>

    <!-- Add Modal -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-light rounded-top">
                    <h5 class="modal-title" id="addModalLabel">Add Person</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="add-name" class="form-label fw-semibold">Name</label>
                        <input id="add-name" class="form-control" required />
                        <span id="add-name-error" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label for="add-nickname" class="form-label fw-semibold">Nickname</label>
                        <input id="add-nickname" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="add-bsfamily" class="form-label fw-semibold">BS Family</label>
                        <select id="add-bsfamily" class="form-select" required>
                            <option value="" disabled selected>Select BS Family</option>
                            <option value="None">None</option>
                            <!-- Populated by JavaScript -->
                        </select>
                        <span id="add-bsfamily-error" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label for="add-ministry" class="form-label fw-semibold">Ministry</label>
                        <select id="add-ministry" class="form-select" required>
                            <option value="" disabled selected>Select Ministry</option>
                            <option value="None">None</option>
                            <!-- Populated by JavaScript -->
                        </select>
                        <span id="add-ministry-error" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label for="add-contactnumber" class="form-label fw-semibold">Contact No.</label>
                        <input id="add-contactnumber" class="form-control" type="tel" />
                        <span id="add-contactnumber-error" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label for="add-birthdate" class="form-label fw-semibold">Birthdate</label>
                        <input id="add-birthdate" class="form-control" type="date" />
                    </div>
                    <div class="mb-3">
                        <label for="add-countryaddress" class="form-label fw-semibold">Country Address</label>
                        <input id="add-countryaddress" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="add-ksaaddress" class="form-label fw-semibold">KSA Address</label>
                        <input id="add-ksaaddress" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="add-company" class="form-label fw-semibold">Company</label>
                        <input id="add-company" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="add-jobposition" class="form-label fw-semibold">Job Position</label>
                        <input id="add-jobposition" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="add-firstworshipdate" class="form-label fw-semibold">1st Worship Date</label>
                        <input id="add-firstworshipdate" class="form-control" type="date" />
                    </div>
                    <div class="mb-3">
                        <label for="add-baptizeddate" class="form-label fw-semibold">Baptized Date</label>
                        <input id="add-baptizeddate" class="form-control" type="date" />
                    </div>
                    <div class="mb-3">
                        <label for="add-remarks" class="form-label fw-semibold">Remarks</label>
                        <input id="add-remarks" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer bg-light rounded-bottom">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addPerson()">Save Person</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-light rounded-top">
                    <h5 class="modal-title" id="editModalLabel">Edit Person</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="edit-id" />
                    <div class="mb-3">
                        <label for="edit-name" class="form-label fw-semibold">Name</label>
                        <input id="edit-name" class="form-control" required />
                        <span id="edit-name-error" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label for="edit-nickname" class="form-label fw-semibold">Nickname</label>
                        <input id="edit-nickname" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-bsfamily" class="form-label fw-semibold">BS Family</label>
                        <select id="edit-bsfamily" class="form-select" required>
                            <option value="" disabled>Select BS Family</option>
                            <option value="None">None</option>
                            <!-- Populated by JavaScript -->
                        </select>
                        <span id="edit-bsfamily-error" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label for="edit-ministry" class="form-label fw-semibold">Ministry</label>
                        <select id="edit-ministry" class="form-select" required>
                            <option value="" disabled>Select Ministry</option>
                            <option value="None">None</option>
                            <!-- Populated by JavaScript -->
                        </select>
                        <span id="edit-ministry-error" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label for="edit-contactnumber" class="form-label fw-semibold">Contact No.</label>
                        <input id="edit-contactnumber" class="form-control" type="tel" />
                        <span id="edit-contactnumber-error" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label for="edit-birthdate" class="form-label fw-semibold">Birthdate</label>
                        <input id="edit-birthdate" class="form-control" type="date" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-countryaddress" class="form-label fw-semibold">Country Address</label>
                        <input id="edit-countryaddress" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-ksaaddress" class="form-label fw-semibold">KSA Address</label>
                        <input id="edit-ksaaddress" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-company" class="form-label fw-semibold">Company</label>
                        <input id="edit-company" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-jobposition" class="form-label fw-semibold">Job Position</label>
                        <input id="edit-jobposition" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-firstworshipdate" class="form-label fw-semibold">1st Worship Date</label>
                        <input id="edit-firstworshipdate" class="form-control" type="date" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-baptizeddate" class="form-label fw-semibold">Baptized Date</label>
                        <input id="edit-baptizeddate" class="form-control" type="date" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-remarks" class="form-label fw-semibold">Remarks</label>
                        <input id="edit-remarks" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer bg-light rounded-bottom">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updatePerson()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-light rounded-top">
                    <h5 class="modal-title" id="importModalLabel">Import from Excel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label fw-semibold">Select Excel File</label>
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls" />
                        <div class="form-text">Supported formats: .xlsx, .xls</div>
                    </div>
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Excel File Format</h6>
                        <p class="mb-0">Your Excel file should have the following columns (extra columns are ignored):</p>
                        <ul class="mb-0">
                            <li>NAME <b>(required)</b></li>
                            <li>NICKNAME (optional)</li>
                            <li>BS FAMILY <b>(required)</b></li>
                            <li>MINISTRY <b>(required)</b></li>
                            <li>CONTACT NO. (optional)</li>
                            <li>Birthdate (optional, format: DD/MM/YYYY)</li>
                            <li>COUNTRY ADDRESS (optional)</li>
                            <li>KSA ADDRESS (optional)</li>
                            <li>COMPANY (optional)</li>
                            <li>JOB Position (optional)</li>
                            <li>1ST WORSHIP DATE (optional, format: DD/MM/YYYY)</li>
                            <li>BAPTIZED DATE (optional, format: DD/MM/YYYY)</li>
                            <li>REMARKS (optional)</li>
                        </ul>
                        <p class="mb-0 mt-2 small">All columns above will be imported if present. Dates must be in DD/MM/YYYY format.</p>
                    </div>
                </div>
                <div class="modal-footer bg-light rounded-bottom">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="importExcel()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Event Modal -->
    <div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white rounded-top">
                    <h5 class="modal-title" id="deleteEventModalLabel">Delete Person</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <i class="fa-solid fa-triangle-exclamation text-danger fa-3x mb-3"></i>
                    <p class="mb-0">Are you sure you want to delete this person?</p>
                    <p class="text-muted small">This action cannot be undone.</p>
                    <input type="hidden" id="delete-event-id" />
                </div>
                <div class="modal-footer bg-light rounded-bottom">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Firebase Compatibility SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- SheetJS for Excel handling (must be first!) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Initialize Firebase -->
    <script>
        // Declare db globally
        let db = null;

        try {
            const firebaseConfig = @Html.Raw(Model.FirebaseConfigJson);
            console.log("Firebase Config:", firebaseConfig);
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                throw new Error("Firebase configuration is empty or invalid");
            }
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully, db:", !!db);
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
    </script>

    <!-- Chart.js and jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>

    <script>
        let people = [];
        let bsFamilies = [];
        let ministries = [];
        let currentPage = @Model.CurrentPage;
        const pageSize = @Model.PageSize;
        let totalItems = 0;
        let totalPages = 0;
        let sortOrder = '@Model.SortOrder' || 'name_asc';
        let searchTerm = '@Model.SearchTerm' || '';

        window.onload = function () {
            if (!db) {
                console.error("Firestore db is not initialized.");
                showError("Failed to load data. Please check Firebase configuration.");
                return;
            }
            loadCategories();
            loadPeople();
        };

        // Load Categories (BS Family and Ministry)
        async function loadCategories() {
            try {
                console.log("Loading categories from Firestore...");
                const snapshot = await db.collection('categories').get();
                console.log("Categories snapshot size:", snapshot.size);
                console.log("Category documents:", snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })));
                bsFamilies = [];
                ministries = [];

                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    console.log("Processing category:", doc.id, data);
                    if (data.Title && data.Title.toLowerCase() === "bs family") {
                        console.log("Found BS Family category:", doc.id);
                        const itemsSnapshot = await db.collection('categories').doc(doc.id).collection('items').get();
                        console.log("BS Family items snapshot size:", itemsSnapshot.size);
                        console.log("BS Family items:", itemsSnapshot.docs.map(itemDoc => ({ id: itemDoc.id, data: itemDoc.data() })));
                        bsFamilies = itemsSnapshot.docs.map(itemDoc => ({
                            Id: itemDoc.id,
                            Name: itemDoc.data().Name || "Unknown"
                        }));
                    } else if (data.Title && data.Title.toLowerCase() === "ministry") {
                        console.log("Found Ministry category:", doc.id);
                        const itemsSnapshot = await db.collection('categories').doc(doc.id).collection('items').get();
                        console.log("Ministry items snapshot size:", itemsSnapshot.size);
                        console.log("Ministry items:", itemsSnapshot.docs.map(itemDoc => ({ id: itemDoc.id, data: itemDoc.data() })));
                        ministries = itemsSnapshot.docs.map(itemDoc => ({
                            Id: itemDoc.id,
                            Name: itemDoc.data().Name || "Unknown"
                        }));
                    }
                }

                console.log("BS Families:", bsFamilies);
                console.log("Ministries:", ministries);
                populateDropdowns();
            } catch (error) {
                console.error("Error loading categories:", error);
                showError(`Failed to load BS Families or Ministries: ${error.message}`);
            }
        }

        // Populate BS Family and Ministry Dropdowns
        function populateDropdowns() {
            const addBSFamily = document.getElementById('add-bsfamily');
            const editBSFamily = document.getElementById('edit-bsfamily');
            const addMinistry = document.getElementById('add-ministry');
            const editMinistry = document.getElementById('edit-ministry');

            // Clear existing options (except default and None)
            addBSFamily.innerHTML = '<option value="" disabled selected>Select BS Family</option><option value="None">None</option>';
            editBSFamily.innerHTML = '<option value="" disabled>Select BS Family</option><option value="None">None</option>';
            addMinistry.innerHTML = '<option value="" disabled selected>Select Ministry</option><option value="None">None</option>';
            editMinistry.innerHTML = '<option value="" disabled>Select Ministry</option><option value="None">None</option>';

            // Populate BS Family dropdowns
            bsFamilies.forEach(family => {
                const option = `<option value="${family.Name}">${family.Name}</option>`;
                addBSFamily.innerHTML += option;
                editBSFamily.innerHTML += option;
            });

            // Populate Ministry dropdowns
            ministries.forEach(ministry => {
                const option = `<option value="${ministry.Name}">${ministry.Name}</option>`;
                addMinistry.innerHTML += option;
                editMinistry.innerHTML += option;
            });
        }

        function loadPeople() {
            try {
                console.log("Loading people from Firestore...");
                let query = db.collection('people');
                if (searchTerm) {
                    query = query.where('Name', '>=', searchTerm.toLowerCase())
                                 .where('Name', '<=', searchTerm.toLowerCase() + '\uf8ff');
                }

                query.get().then(snapshot => {
                    people = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        people.push({
                            Id: doc.id,
                            Name: data.DisplayName || data.Name || '',
                            Nickname: data.Nickname || '',
                            BSFamily: data.BSFamily || '',
                            Ministry: data.Ministry || '',
                            ContactNumber: data.ContactNumber || '',
                            Birthdate: data.Birthdate ? (data.Birthdate.seconds ? new Date(data.Birthdate.seconds * 1000) : new Date(data.Birthdate)) : null,
                            CountryAddress: data.CountryAddress || '',
                            KSAAddress: data.KSAAddress || '',
                            Company: data.Company || '',
                            JobPosition: data.JobPosition || '',
                            FirstWorshipDate: data.FirstWorshipDate ? (data.FirstWorshipDate.seconds ? new Date(data.FirstWorshipDate.seconds * 1000) : new Date(data.FirstWorshipDate)) : null,
                            BaptizedDate: data.BaptizedDate ? (data.BaptizedDate.seconds ? new Date(data.BaptizedDate.seconds * 1000) : new Date(data.BaptizedDate)) : null,
                            Remarks: data.Remarks || ''
                        });
                    });

                    console.log("People loaded:", people.length);
                    if (sortOrder === 'name_desc') {
                        people.sort((a, b) => b.Name.localeCompare(a.Name));
                    } else {
                        people.sort((a, b) => a.Name.localeCompare(a.Name));
                    }

                    totalItems = people.length;
                    totalPages = Math.ceil(totalItems / pageSize);
                    currentPage = Math.max(1, Math.min(currentPage, totalPages));
                    renderTable();
                    updatePagination();
                    updateSummary();
                }).catch(error => {
                    console.error("Error loading people:", error);
                    showError("Error loading people from Firestore.");
                });
            } catch (error) {
                console.error("Unexpected error in loadPeople:", error);
                showError("Unexpected error loading data.");
            }
        }

        function renderTable() {
            const tbody = document.getElementById('person-table-body');
            tbody.innerHTML = '';
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, people.length);

            function formatDate(date) {
                if (!date) return 'N/A';
                if (!(date instanceof Date)) date = new Date(date);
                if (isNaN(date)) return 'N/A';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            for (let i = start; i < end; i++) {
                const person = people[i];
                const row = `
                    <tr>
                        <td>${person.Name || 'N/A'}</td>
                        <td>${person.Nickname || 'N/A'}</td>
                        <td>${person.BSFamily || 'N/A'}</td>
                        <td>${person.Ministry || 'N/A'}</td>
                        <td>${person.ContactNumber || 'N/A'}</td>
                        <td>${formatDate(person.Birthdate)}</td>
                        <td>${person.CountryAddress || 'N/A'}</td>
                        <td>${person.KSAAddress || 'N/A'}</td>
                        <td>${person.Company || 'N/A'}</td>
                        <td>${person.JobPosition || 'N/A'}</td>
                        <td>${formatDate(person.FirstWorshipDate)}</td>
                        <td>${formatDate(person.BaptizedDate)}</td>
                        <td>${person.Remarks || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" data-bs-tooltip="tooltip" title="Edit" onclick="openEdit('${person.Id}')"><i class="fa-solid fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" data-bs-tooltip="tooltip" title="Delete" onclick="openDeleteEvent('${person.Id}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        }

        function updateSummary() {
            const totalPeople = people.length;
            const bsFamiliesSet = [...new Set(people.map(p => p.BSFamily).filter(f => f && f !== 'None'))];
            const ministriesSet = [...new Set(people.map(p => p.Ministry).filter(m => m && m !== 'None'))];

            document.getElementById('total-people').innerText = totalPeople;
            document.getElementById('bs-families').innerText = bsFamiliesSet.length;
            document.getElementById('ministries').innerText = ministriesSet.length;
        }

        function updatePagination() {
            const start = currentPage === 1 ? 1 : (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalItems);
            document.getElementById('pagination-info').innerText = `${start}-${end} of ${totalItems} | Page ${currentPage}`;

            const pagination = document.querySelector('.pagination');
            pagination.innerHTML = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}" id="prev-page">
                    <a class="page-link" href="#" aria-label="Previous"><i class="fa-solid fa-angle-left"></i></a>
                </li>
            `;

            for (let i = 1; i <= totalPages; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            pagination.innerHTML += `
                <li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}" id="next-page">
                    <a class="page-link" href="#" aria-label="Next"><i class="fa-solid fa-angle-right"></i></a>
                </li>
            `;

            document.querySelectorAll('#prev-page a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) changePage(currentPage - 1);
                });
            });

            document.querySelectorAll('#next-page a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) changePage(currentPage + 1);
                });
            });
        }

        function changePage(page) {
            currentPage = page;
            renderTable();
            updatePagination();
        }

        // Copy All People Data
        function copyAllData(button) {
            if (people.length === 0) {
                showError('No people to copy.');
                return;
            }

            // Format people data in a messenger-friendly format
            const rows = people.map(person => {
                const birthdate = person.Birthdate
                    ? person.Birthdate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })
                    : 'N/A';
                const displayName = person.DisplayName || person.Name || '';
                return [
                    `• Name: ${displayName}`,
                    `  - BS Family: ${person.BSFamily || 'N/A'}`,
                    `  - Ministry: ${person.Ministry || 'N/A'}`,
                    `  - Contact No.: ${person.ContactNumber || 'N/A'}`,
                    `  - KSA Address: ${person.KSAAddress || 'N/A'}`,
                    `  - Birthdate: ${birthdate}`
                ].join('\n');
            });

            // Join rows with double newlines for separation
            const textToCopy = rows.join('\n\n');

            // Use Clipboard API to copy text
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Create feedback element
                const feedback = document.createElement('span');
                feedback.className = 'copy-feedback';
                feedback.innerText = 'Copied!';
                button.parentElement.appendChild(feedback);

                // Position feedback near the button
                const rect = button.getBoundingClientRect();
                feedback.style.top = `${rect.top - 30}px`;
                feedback.style.left = `${rect.left + rect.width / 2}px`;

                // Show feedback
                feedback.classList.add('show');

                // Remove feedback after 2 seconds
                setTimeout(() => {
                    feedback.classList.remove('show');
                    setTimeout(() => feedback.remove(), 300); // Wait for fade-out transition
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy all data:', err);
                showError('Failed to copy people data.');
            });
        }

        function addPerson() {
            if (!db) {
                console.error("Cannot add person: Firestore db is not initialized");
                showError("Failed to save person. Database not initialized.");
                return;
            }
            const name = document.getElementById('add-name').value.trim();
            const nickname = document.getElementById('add-nickname').value.trim();
            const bsFamily = document.getElementById('add-bsfamily').value;
            const ministry = document.getElementById('add-ministry').value;
            const contactNumber = document.getElementById('add-contactnumber').value.trim();
            const ksaAddress = document.getElementById('add-ksaaddress').value.trim();
            const countryAddress = document.getElementById('add-countryaddress').value.trim();
            const company = document.getElementById('add-company').value.trim();
            const jobPosition = document.getElementById('add-jobposition').value.trim();
            const firstWorshipDate = document.getElementById('add-firstworshipdate').value;
            const baptizedDate = document.getElementById('add-baptizeddate').value;
            const remarks = document.getElementById('add-remarks').value.trim();
            const birthdate = document.getElementById('add-birthdate').value;

            // Reset errors
            document.getElementById('add-name-error').innerText = '';
            document.getElementById('add-bsfamily-error').innerText = '';
            document.getElementById('add-ministry-error').innerText = '';
            document.getElementById('add-contactnumber-error').innerText = '';

            if (!name) {
                document.getElementById('add-name-error').innerText = 'Name is required';
                return;
            }
            if (!bsFamily) {
                document.getElementById('add-bsfamily-error').innerText = 'BS Family is required';
                return;
            }
            if (!ministry) {
                document.getElementById('add-ministry-error').innerText = 'Ministry is required';
                return;
            }
            if (contactNumber && !/^\+?\d{10,15}$/.test(contactNumber)) {
                document.getElementById('add-contactnumber-error').innerText = 'Invalid phone number';
                return;
            }

            const person = {
                Name: name.toLowerCase(),
                DisplayName: name,
                Nickname: nickname,
                BSFamily: bsFamily,
                Ministry: ministry,
                ContactNumber: contactNumber,
                KSAAddress: ksaAddress,
                CountryAddress: countryAddress,
                Company: company,
                JobPosition: jobPosition,
                FirstWorshipDate: firstWorshipDate ? new Date(firstWorshipDate) : null,
                BaptizedDate: baptizedDate ? new Date(baptizedDate) : null,
                Remarks: remarks,
                Birthdate: birthdate ? new Date(birthdate) : null
            };

            db.collection('people').add(person).then(() => {
                $('#addModal').modal('hide');
                document.getElementById('add-name').value = '';
                document.getElementById('add-nickname').value = '';
                document.getElementById('add-bsfamily').value = '';
                document.getElementById('add-ministry').value = '';
                document.getElementById('add-contactnumber').value = '';
                document.getElementById('add-ksaaddress').value = '';
                document.getElementById('add-countryaddress').value = '';
                document.getElementById('add-company').value = '';
                document.getElementById('add-jobposition').value = '';
                document.getElementById('add-firstworshipdate').value = '';
                document.getElementById('add-baptizeddate').value = '';
                document.getElementById('add-remarks').value = '';
                document.getElementById('add-birthdate').value = '';
                document.getElementById('add-name-error').innerText = '';
                document.getElementById('add-bsfamily-error').innerText = '';
                document.getElementById('add-ministry-error').innerText = '';
                document.getElementById('add-contactnumber-error').innerText = '';
                loadPeople();
                showSuccess("Person added successfully!");
            }).catch(error => {
                console.error("Error adding person:", error);
                showError("Failed to add person.");
            });
        }

        function openEdit(id) {
            const person = people.find(p => p.Id === id);
            if (person) {
                document.getElementById('edit-id').value = person.Id;
                document.getElementById('edit-name').value = person.DisplayName || person.Name || '';
                document.getElementById('edit-nickname').value = person.Nickname || '';
                document.getElementById('edit-bsfamily').value = person.BSFamily || 'None';
                document.getElementById('edit-ministry').value = person.Ministry || 'None';
                document.getElementById('edit-contactnumber').value = person.ContactNumber || '';
                document.getElementById('edit-birthdate').value = person.Birthdate ? person.Birthdate.toISOString().split('T')[0] : '';
                document.getElementById('edit-countryaddress').value = person.CountryAddress || '';
                document.getElementById('edit-ksaaddress').value = person.KSAAddress || '';
                document.getElementById('edit-company').value = person.Company || '';
                document.getElementById('edit-jobposition').value = person.JobPosition || '';
                document.getElementById('edit-firstworshipdate').value = person.FirstWorshipDate ? person.FirstWorshipDate.toISOString().split('T')[0] : '';
                document.getElementById('edit-baptizeddate').value = person.BaptizedDate ? person.BaptizedDate.toISOString().split('T')[0] : '';
                document.getElementById('edit-remarks').value = person.Remarks || '';
                $('#editModal').modal('show');
            }
        }

        function updatePerson() {
            if (!db) {
                console.error("Cannot update person: Firestore db is not initialized");
                showError("Failed to update person. Database not initialized.");
                return;
            }
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value.trim();
            const nickname = document.getElementById('edit-nickname').value.trim();
            const bsFamily = document.getElementById('edit-bsfamily').value;
            const ministry = document.getElementById('edit-ministry').value;
            const contactNumber = document.getElementById('edit-contactnumber').value.trim();
            const birthdate = document.getElementById('edit-birthdate').value;
            const countryAddress = document.getElementById('edit-countryaddress').value.trim();
            const ksaAddress = document.getElementById('edit-ksaaddress').value.trim();
            const company = document.getElementById('edit-company').value.trim();
            const jobPosition = document.getElementById('edit-jobposition').value.trim();
            const firstWorshipDate = document.getElementById('edit-firstworshipdate').value;
            const baptizedDate = document.getElementById('edit-baptizeddate').value;
            const remarks = document.getElementById('edit-remarks').value.trim();

            // Reset errors
            document.getElementById('edit-name-error').innerText = '';
            document.getElementById('edit-bsfamily-error').innerText = '';
            document.getElementById('edit-ministry-error').innerText = '';
            document.getElementById('edit-contactnumber-error').innerText = '';

            if (!name) {
                document.getElementById('edit-name-error').innerText = 'Name is required';
                return;
            }
            if (!bsFamily) {
                document.getElementById('edit-bsfamily-error').innerText = 'BS Family is required';
                return;
            }
            if (!ministry) {
                document.getElementById('edit-ministry-error').innerText = 'Ministry is required';
                return;
            }
            if (contactNumber && !/^\+?\d{10,15}$/.test(contactNumber)) {
                document.getElementById('edit-contactnumber-error').innerText = 'Invalid phone number';
                return;
            }

            const person = {
                Name: name.toLowerCase(),
                DisplayName: name,
                Nickname: nickname,
                BSFamily: bsFamily,
                Ministry: ministry,
                ContactNumber: contactNumber,
                Birthdate: birthdate ? new Date(birthdate) : null,
                CountryAddress: countryAddress,
                KSAAddress: ksaAddress,
                Company: company,
                JobPosition: jobPosition,
                FirstWorshipDate: firstWorshipDate ? new Date(firstWorshipDate) : null,
                BaptizedDate: baptizedDate ? new Date(baptizedDate) : null,
                Remarks: remarks
            };

            db.collection('people').doc(id).update(person).then(() => {
                $('#editModal').modal('hide');
                document.getElementById('edit-name-error').innerText = '';
                document.getElementById('edit-bsfamily-error').innerText = '';
                document.getElementById('edit-ministry-error').innerText = '';
                document.getElementById('edit-contactnumber-error').innerText = '';
                loadPeople();
                showSuccess("Person updated successfully!");
            }).catch(error => {
                console.error("Error updating person:", error);
                showError("Failed to update person.");
            });
        }

        function openDeleteEvent(id) {
            document.getElementById('delete-event-id').value = id;
            $('#deleteEventModal').modal('show');
        }

        document.getElementById('confirm-delete').addEventListener('click', function () {
            const id = document.getElementById('delete-event-id').value;
            db.collection('people').doc(id).delete().then(() => {
                $('#deleteEventModal').modal('hide');
                loadPeople();
                showSuccess("Records deleted successfully!");
            }).catch(error => {
                console.error("Error deleting record:", error);
                showError("Failed to delete record. Please try again.");
            });
        });
        
        function openDetail(id) {
            alert('Detail view for ID: ' + id);
        }

        // Show Success Message
        function showSuccess(message) {
            const successCard = document.getElementById('success-card');
            const successMessage = document.getElementById('success-message');
            if (successCard && successMessage) {
                successMessage.innerText = message;
                successCard.classList.remove('d-none');
                setTimeout(() => successCard.classList.add('d-none'), 5000);
            } else {
                console.error("Success card or message element not found");
            }
        }

        // Show Error Message
        function showError(message) {
            const successCard = document.getElementById('success-card');
            const successMessage = document.getElementById('success-message');
            if (successCard && successMessage) {
                successMessage.innerText = message;
                successCard.classList.remove('d-none');
                successCard.classList.remove('border-success');
                successCard.classList.add('border-danger');
                successCard.querySelector('.card-title').classList.remove('text-success');
                successCard.querySelector('.card-title').classList.add('text-danger');
                successCard.querySelector('.card-title').innerText = 'Error!';
                setTimeout(() => {
                    successCard.classList.add('d-none');
                    successCard.classList.remove('border-danger');
                    successCard.classList.add('border-success');
                    successCard.querySelector('.card-title').classList.remove('text-danger');
                    successCard.querySelector('.card-title').classList.add('text-success');
                    successCard.querySelector('.card-title').innerText = 'Success!';
                }, 5000);
            } else {
                console.error("Success card or message element not found");
                alert(message); // Fallback to alert if card not found
            }
        }

        // Add null checks before adding event listeners
        const searchForm = document.getElementById('search-form');
        if (searchForm) {
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                searchTerm = document.getElementById('search-term').value;
                currentPage = 1;
                loadPeople();
            });
        }

        const sortName = document.getElementById('sort-name');
        if (sortName) {
            sortName.addEventListener('click', (e) => {
                e.preventDefault();
                sortOrder = sortOrder === 'name_asc' ? 'name_desc' : 'name_asc';
                loadPeople();
            });
        }

        const confirmDelete = document.getElementById('confirm-delete');
        if (confirmDelete) {
            confirmDelete.addEventListener('click', function () {
                const id = document.getElementById('delete-event-id').value;
                db.collection('people').doc(id).delete().then(() => {
                    $('#deleteEventModal').modal('hide');
                    loadPeople();
                    showSuccess("Records deleted successfully!");
                }).catch(error => {
                    console.error("Error deleting record:", error);
                    showError("Failed to delete record. Please try again.");
                });
            });
        }

        // Import Excel File
        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const feedback = document.getElementById('import-feedback');
            const importBtn = document.getElementById('importBtn');
            if (feedback) { feedback.style.display = 'none'; feedback.innerText = ''; }
            if (importBtn) { importBtn.disabled = true; importBtn.innerText = 'Importing...'; }

            const file = fileInput.files[0];
            if (!file) {
                if (feedback) { feedback.innerText = 'Please select a file to import.'; feedback.style.display = 'block'; }
                if (importBtn) { importBtn.disabled = false; importBtn.innerText = 'Import'; }
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (typeof XLSX === 'undefined') {
                        if (feedback) { feedback.innerText = 'Excel library not loaded. Please refresh the page.'; feedback.style.display = 'block'; }
                        if (importBtn) { importBtn.disabled = false; importBtn.innerText = 'Import'; }
                        return;
                    }
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        if (feedback) { feedback.innerText = 'No data found in the Excel file.'; feedback.style.display = 'block'; }
                        if (importBtn) { importBtn.disabled = false; importBtn.innerText = 'Import'; }
                        return;
                    }

                    // No longer block import if required fields are missing
                    // Helper to parse DD/MM/YYYY, DD-MMM-YY, etc.
                    function parseDDMMYYYY(val) {
                        if (!val) return null;
                        if (val instanceof Date) return val;
                        if (typeof val === 'number') return new Date(val);
                        if (typeof val === 'string') {
                            // Try DD/MM/YYYY or DD-MM-YYYY or DD-MMM-YY/YY
                            let parts = val.split(/[\/\-]/);
                            if (parts.length === 3) {
                                // If month is a string (e.g., "Jan")
                                if (isNaN(parts[1])) {
                                    // Try to parse month name
                                    const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
                                    const monthIndex = months.indexOf(parts[1].toLowerCase().substring(0,3));
                                    if (monthIndex !== -1) {
                                        let year = parts[2];
                                        if (year.length === 2) {
                                            // crude Y2K fix: treat 00-49 as 2000-2049, 50-99 as 1950-1999
                                            const yr = parseInt(year, 10);
                                            year = (yr < 50 ? 2000 + yr : 1900 + yr).toString();
                                        }
                                        return new Date(parseInt(year, 10), monthIndex, parseInt(parts[0], 10));
                                    }
                                } else {
                                    // Numeric month
                                    return new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
                                }
                            }
                            // fallback: try Date constructor
                            const d = new Date(val);
                            if (!isNaN(d)) return d;
                        }
                        return null;
                    }

                    // Log headers and a sample row for debugging
                    function logExcelHeadersAndSampleRow(jsonData) {
                        if (!jsonData || jsonData.length === 0) {
                            console.warn('Excel import: No data found.');
                            return;
                        }
                        const headers = Object.keys(jsonData[0]);
                        console.log('Excel Detected Headers:', headers);
                        console.log('Excel First Row Sample:', jsonData[0]);
                    }

                    logExcelHeadersAndSampleRow(jsonData);

                    // Process each row, mapping all relevant columns
                    const importPromises = jsonData.map(row => {
                        function safeField(val, fallback = 'N/A') {
                            return (val && val.toString().trim() !== '') ? val.toString() : fallback;
                        }
                        const person = {
                            Name: safeField(row['NAME']),
                            DisplayName: safeField(row['NAME']),
                            Nickname: safeField(row['NICKNAME']),
                            BSFamily: safeField(row['BS FAMILY'], 'None'),
                            Ministry: safeField(row['MINISTRY'], 'None'),
                            ContactNumber: safeField(row['CONTACT NO.']),
                            Birthdate: parseDDMMYYYY(row['Birthdate']),
                            CountryAddress: safeField(row['COUNTRY ADDRESS']),
                            KSAAddress: safeField(row['KSA ADDRESS']),
                            Company: safeField(row['COMPANY']),
                            JobPosition: safeField(row['JOB Position']),
                            FirstWorshipDate: parseDDMMYYYY(row['1ST WORSHIP DATE']),
                            BaptizedDate: parseDDMMYYYY(row['BAPTIZED DATE']),
                            Remarks: safeField(row['REMARKS'])
                        };
                        return db.collection('people').add(person);
                    });

                    Promise.all(importPromises)
                        .then(() => {
                            $('#importModal').modal('hide');
                            fileInput.value = '';
                            loadPeople();
                            showSuccess(`Successfully imported ${jsonData.length} records!`);
                        })
                        .catch(error => {
                            if (feedback) { feedback.innerText = 'Failed to import some records. Please check the data format.'; feedback.style.display = 'block'; }
                        });
                } catch (error) {
                    if (feedback) { feedback.innerText = 'Error processing the Excel file. Please check the file format.'; feedback.style.display = 'block'; }
                }
                if (importBtn) { importBtn.disabled = false; importBtn.innerText = 'Import'; }
            };
            reader.onerror = function() {
                if (feedback) { feedback.innerText = 'Error reading the file.'; feedback.style.display = 'block'; }
                if (importBtn) { importBtn.disabled = false; importBtn.innerText = 'Import'; }
            };
            reader.readAsArrayBuffer(file);
        }

        // Export to Excel
        const exportBtn = document.getElementById('exportBtnMaster');
        // Remove any existing event listeners
        const newExportBtn = exportBtn.cloneNode(true);
        exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);
        
        newExportBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent any default behavior
            
            if (people.length === 0) {
                showError('No data to export.');
                return;
            }

            // Format dates to DD/MM/YYYY
            function formatDateForExport(date) {
                if (!date) return '';
                if (!(date instanceof Date)) date = new Date(date);
                if (isNaN(date)) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Prepare data for export
            const exportData = people.map(person => {
                // Get the name from DisplayName or Name field
                const displayName = person.DisplayName || person.Name || '';
                
                return {
                    'NAME': displayName,
                    'NICKNAME': person.Nickname || '',
                    'BS FAMILY': person.BSFamily || '',
                    'MINISTRY': person.Ministry || '',
                    'CONTACT NO.': person.ContactNumber || '',
                    'Birthdate': formatDateForExport(person.Birthdate),
                    'COUNTRY ADDRESS': person.CountryAddress || '',
                    'KSA ADDRESS': person.KSAAddress || '',
                    'COMPANY': person.Company || '',
                    'JOB Position': person.JobPosition || '',
                    '1ST WORSHIP DATE': formatDateForExport(person.FirstWorshipDate),
                    'BAPTIZED DATE': formatDateForExport(person.BaptizedDate),
                    'REMARKS': person.Remarks || ''
                };
            });

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Set column widths
            const wscols = [
                {wch: 30}, // NAME
                {wch: 15}, // NICKNAME
                {wch: 20}, // BS FAMILY
                {wch: 20}, // MINISTRY
                {wch: 15}, // CONTACT NO.
                {wch: 12}, // Birthdate
                {wch: 30}, // COUNTRY ADDRESS
                {wch: 30}, // KSA ADDRESS
                {wch: 20}, // COMPANY
                {wch: 20}, // JOB Position
                {wch: 12}, // 1ST WORSHIP DATE
                {wch: 12}, // BAPTIZED DATE
                {wch: 30}  // REMARKS
            ];
            ws['!cols'] = wscols;

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "People List");

            // Generate Excel file
            const fileName = `People_List_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        });

    </script>
}