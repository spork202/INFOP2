@page
@model INFOP2.Pages.Masterlist
@{
    ViewData["Title"] = "Masterlist";
    Layout = "_Layout";
}

<div class="container mt-5">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2 class="fw-bold">@ViewData["Title"]</h2>
            <h4 class="h6">Hello, <strong>@User.Identity?.Name</strong></h4>
        </div>
        <div class="col-12 d-flex justify-content-between align-items-center">
            <p class="text-muted">Manage your people</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-5">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-start border-4 border-primary">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-users text-primary fa-2x me-3"></i>
                    <div>
                        <h6 class="card-subtitle mb-1 text-muted">Total People</h6>
                        <h4 class="card-title mb-0" id="total-people">0</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-start border-4 border-success">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-home text-success fa-2x me-3"></i>
                    <div>
                        <h6 class="card-subtitle mb-1 text-muted">BC Families</h6>
                        <h4 class="card-title mb-0" id="bc-families">0</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-start border-4 border-warning">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-church text-warning fa-2x me-3"></i>
                    <div>
                        <h6 class="card-subtitle mb-1 text-muted">Ministries</h6>
                        <h4 class="card-title mb-0" id="ministries">0</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title">People by BC Family</h5>
                    <canvas id="masterlistChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Add Button -->
    <div class="row mb-3 align-items-center">
        <div class="col-md-6 mb-3 mb-md-0">
            <form id="search-form" method="get" class="d-flex">
                <input type="text" class="form-control me-2" placeholder="Search by name..." asp-for="SearchTerm" id="search-term" />
                <button type="submit" class="btn btn-outline-primary">Search</button>
            </form>
        </div>
        <div class="col-md-6 text-md-end">
            <button id="add-btn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">
                <i class="fas fa-plus me-1"></i> Add Person
            </button>
            <button class="btn btn-outline-secondary">
                <i class="fa fa-download"></i>
            </button>
        </div>
    </div>

    <!-- Masterlist Table -->
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h5>People List</h5>
            <a href="#" class="text-primary">View All</a>
        </div>
    </div>

    <div id="table-container">
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <a id="sort-name" href="#" class="text-dark text-decoration-none">
                                    Name <span id="sort-icon">@(Model.SortOrder == "name_asc" ? "▲" : Model.SortOrder == "name_desc" ? "▼" : "")</span>
                                </a>
                            </th>
                            <th>BC Family</th>
                            <th>Ministry</th>
                            <th>Contact No.</th>
                            <th>KSA Address</th>
                            <th>Birthdate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="person-table-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-end align-items-center mt-3" id="pagination-container">
            <small class="me-3 text-muted" id="pagination-info"></small>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <!-- Dynamically populated -->
                </ul>
            </nav>
        </div>
    </div>

    <div id="no-data" class="text-center mt-4" style="display: none;">
        <p class="text-muted">No people in the list. Click "Add Person" to start.</p>
    </div>

    <!-- Add Modal -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addModalLabel">Add Person</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add-name" class="form-label">Name</label>
                        <input id="add-name" class="form-control" required />
                        <span id="add-name-error" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label for="add-bcfamily" class="form-label">BC Family</label>
                        <select id="add-bcfamily" class="form-select">
                            <option value="" disabled selected>Select BC Family</option>
                            <option value="Family A">Family A</option>
                            <option value="Family B">Family B</option>
                            <option value="Family C">Family C</option>
                            <option value="None">None</option>
                        </select>
                        <span id="add-bcfamily-error" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label for="add-ministry" class="form-label">Ministry</label>
                        <select id="add-ministry" class="form-select">
                            <option value="" disabled selected>Select Ministry</option>
                            <option value="Worship">Worship</option>
                            <option value="Youth">Youth</option>
                            <option value="Outreach">Outreach</option>
                            <option value="None">None</option>
                        </select>
                        <span id="add-ministry-error" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label for="add-contactnumber" class="form-label">Contact No.</label>
                        <input id="add-contactnumber" class="form-control" type="tel" />
                        <span id="add-contactnumber-error" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label for="add-ksaaddress" class="form-label">KSA Address</label>
                        <input id="add-ksaaddress" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="add-birthdate" class="form-label">Birthdate</label>
                        <input id="add-birthdate" class="form-control" type="date" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addPerson()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Person</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id" />
                    <div class="mb-3">
                        <label for="edit-name" class="form-label">Name</label>
                        <input id="edit-name" class="form-control" required />
                        <span id="edit-name-error" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label for="edit-bcfamily" class="form-label">BC Family</label>
                        <select id="edit-bcfamily" class="form-select">
                            <option value="" disabled>Select BC Family</option>
                            <option value="Family A">Family A</option>
                            <option value="Family B">Family B</option>
                            <option value="Family C">Family C</option>
                            <option value="None">None</option>
                        </select>
                        <span id="edit-bcfamily-error" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label for="edit-ministry" class="form-label">Ministry</label>
                        <select id="edit-ministry" class="form-select">
                            <option value="" disabled>Select Ministry</option>
                            <option value="Worship">Worship</option>
                            <option value="Youth">Youth</option>

                            <option value="Outreach">Outreach</option>
                            <option value="None">None</option>
                        </select>
                        <span id="edit-ministry-error" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label for="edit-contactnumber" class="form-label">Contact No.</label>
                        <input id="edit-contactnumber" class="form-control" type="tel" />
                        <span id="edit-contactnumber-error" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label for="edit-ksaaddress" class="form-label">KSA Address</label>
                        <input id="edit-ksaaddress" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label for="edit-birthdate" class="form-label">Birthdate</label>
                        <input id="edit-birthdate" class="form-control" type="date" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updatePerson()">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Firebase Compatibility SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Initialize Firebase -->
    <script>
        // Declare db globally
        let db = null;

        try {
            const firebaseConfig = @Html.Raw(Model.FirebaseConfigJson);
            console.log("Firebase Config:", firebaseConfig); // Debug config
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                throw new Error("Firebase configuration is empty or invalid");
            }
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully, db:", !!db);
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>

    <script>
        let people = [];
        let currentPage = @Model.CurrentPage;
        const pageSize = @Model.PageSize;
        let totalItems = 0;
        let totalPages = 0;
        let sortOrder = '@Model.SortOrder' || 'name_asc';
        let searchTerm = '@Model.SearchTerm' || '';
        let masterlistChart;

        window.onload = function () {
            if (!db) {
                console.error("Firestore db is not initialized. Check Firebase configuration and script loading.");
                document.getElementById('table-container').style.display = 'none';
                document.getElementById('no-data').innerText = 'Failed to load data. Please check Firebase configuration.';
                document.getElementById('no-data').style.display = 'block';
                return;
            }
            loadPeople();
        };

        function loadPeople() {
            try {
                console.log("Loading people from Firestore...");
                let query = db.collection('people');
                if (searchTerm) {
                    query = query.where('Name', '>=', searchTerm.toLowerCase())
                                 .where('Name', '<=', searchTerm.toLowerCase() + '\uf8ff');
                }

                query.get().then(snapshot => {
                    people = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        people.push({
                            Id: doc.id,
                            Name: data.DisplayName || data.Name || '',
                            BCFamily: data.BCFamily || '',
                            Ministry: data.Ministry || '',
                            ContactNumber: data.ContactNumber || '',
                            KSAAddress: data.KSAAddress || '',
                            Birthdate: data.Birthdate ? new Date(data.Birthdate.seconds * 1000) : null
                        });
                    });

                    console.log("People loaded:", people.length);
                    if (sortOrder === 'name_desc') {
                        people.sort((a, b) => b.Name.localeCompare(a.Name));
                    } else {
                        people.sort((a, b) => a.Name.localeCompare(b.Name));
                    }

                    totalItems = people.length;
                    totalPages = Math.ceil(totalItems / pageSize);
                    currentPage = Math.max(1, Math.min(currentPage, totalPages));
                    renderTable();
                    updatePagination();
                    updateSummary();
                    updateChart();

                    document.getElementById('table-container').style.display = people.length ? 'block' : 'none';
                    document.getElementById('no-data').style.display = people.length ? 'none' : 'block';
                }).catch(error => {
                    console.error("Error loading people:", error);
                    document.getElementById('no-data').innerText = 'Error loading data from Firestore.';
                    document.getElementById('no-data').style.display = 'block';
                });
            } catch (error) {
                console.error("Unexpected error in loadPeople:", error);
                document.getElementById('no-data').innerText = 'Unexpected error loading data.';
                document.getElementById('no-data').style.display = 'block';
            }
        }

        function renderTable() {
            const tbody = document.getElementById('person-table-body');
            tbody.innerHTML = '';
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, people.length);

            for (let i = start; i < end; i++) {
                const person = people[i];
                const row = `
                    <tr>
                        <td>${person.Name}</td>
                        <td>${person.BCFamily || 'N/A'}</td>
                        <td>${person.Ministry || 'N/A'}</td>
                        <td>${person.ContactNumber || 'N/A'}</td>
                        <td>${person.KSAAddress || 'N/A'}</td>
                        <td>${person.Birthdate ? person.Birthdate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) : 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1 rounded-pill" onclick="openEdit('${person.Id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger rounded-pill" onclick="deletePerson('${person.Id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        }

        function updateSummary() {
            const totalPeople = people.length;
            const bcFamilies = [...new Set(people.map(p => p.BCFamily).filter(f => f && f !== 'None'))].length;
            const ministries = [...new Set(people.map(p => p.Ministry).filter(m => m && m !== 'None'))].length;

            document.getElementById('total-people').innerText = totalPeople;
            document.getElementById('bc-families').innerText = bcFamilies;
            document.getElementById('ministries').innerText = ministries;
        }

        function updateChart() {
            const bcFamilyCounts = {};
            people.forEach(person => {
                const bcFamily = person.BCFamily || 'None';
                bcFamilyCounts[bcFamily] = (bcFamilyCounts[bcFamily] || 0) + 1;
            });

            const labels = Object.keys(bcFamilyCounts);
            const data = Object.values(bcFamilyCounts);
            const backgroundColors = labels.map((_, index) => `hsl(${(index * 360 / labels.length) % 360}, 70%, 60%)`);

            if (masterlistChart) {
                masterlistChart.destroy();
            }

            const ctx = document.getElementById('masterlistChart').getContext('2d');
            masterlistChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'People',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('60%)', '50%)')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of People', color: '#718096', font: { size: 12 } },
                            ticks: { color: '#718096' },
                            grid: { color: '#edf2f7' }
                        },
                        x: {
                            title: { display: true, text: 'BC Family', color: '#718096', font: { size: 12 } },
                            ticks: { color: '#718096' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updatePagination() {
            const start = currentPage === 1 ? 1 : (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalItems);
            document.getElementById('pagination-info').innerText = `${start}-${end} of ${totalItems} | Page ${currentPage}`;

            const pagination = document.querySelector('.pagination');
            pagination.innerHTML = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}" id="prev-page">
                    <a class="page-link" href="#" aria-label="Previous"><i class="fas fa-angle-left"></i></a>
                </li>
            `;

            for (let i = 1; i <= totalPages; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            pagination.innerHTML += `
                <li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}" id="next-page">
                    <a class="page-link" href="#" aria-label="Next"><i class="fas fa-angle-right"></i></a>
                </li>
            `;

            document.querySelectorAll('#prev-page a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) changePage(currentPage - 1);
                });
            });

            document.querySelectorAll('#next-page a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) changePage(currentPage + 1);
                });
            });
        }

        function changePage(page) {
            currentPage = page;
            renderTable();
            updatePagination();
        }

        function addPerson() {
            if (!db) {
                console.error("Cannot add person: Firestore db is not initialized");
                return;
            }
            const name = document.getElementById('add-name').value;
            const bcFamily = document.getElementById('add-bcfamily').value;
            const ministry = document.getElementById('add-ministry').value;
            const contactNumber = document.getElementById('add-contactnumber').value;
            const ksaAddress = document.getElementById('add-ksaaddress').value;
            const birthdate = document.getElementById('add-birthdate').value;

            if (!name) {
                document.getElementById('add-name-error').innerText = 'Name is required';
                return;
            }
            if (contactNumber && !/^\+?\d{10,15}$/.test(contactNumber)) {
                document.getElementById('add-contactnumber-error').innerText = 'Invalid phone number';
                return;
            }
            if (!bcFamily) {
                document.getElementById('add-bcfamily-error').innerText = 'BC Family is required';
                return;
            }
            if (!ministry) {
                document.getElementById('add-ministry-error').innerText = 'Ministry is required';
                return;
            }

            const person = {
                Name: name.toLowerCase(),
                DisplayName: name,
                BCFamily: bcFamily,
                Ministry: ministry,
                ContactNumber: contactNumber,
                KSAAddress: ksaAddress,
                Birthdate: birthdate ? new Date(birthdate) : null
            };

            db.collection('people').add(person).then(() => {
                $('#addModal').modal('hide');
                document.getElementById('add-name').value = '';
                document.getElementById('add-bcfamily').value = '';
                document.getElementById('add-ministry').value = '';
                document.getElementById('add-contactnumber').value = '';
                document.getElementById('add-ksaaddress').value = '';
                document.getElementById('add-birthdate').value = '';
                document.getElementById('add-name-error').innerText = '';
                document.getElementById('add-bcfamily-error').innerText = '';
                document.getElementById('add-ministry-error').innerText = '';
                document.getElementById('add-contactnumber-error').innerText = '';
                loadPeople();
            }).catch(error => {
                console.error("Error adding person:", error);
            });
        }

        function openEdit(id) {
            const person = people.find(p => p.Id === id);
            if (person) {
                document.getElementById('edit-id').value = person.Id;
                document.getElementById('edit-name').value = person.Name;
                document.getElementById('edit-bcfamily').value = person.BCFamily || '';
                document.getElementById('edit-ministry').value = person.Ministry || '';
                document.getElementById('edit-contactnumber').value = person.ContactNumber || '';
                document.getElementById('edit-ksaaddress').value = person.KSAAddress || '';
                document.getElementById('edit-birthdate').value = person.Birthdate ? person.Birthdate.toISOString().split('T')[0] : '';
                $('#editModal').modal('show');
            }
        }

        function updatePerson() {
            if (!db) {
                console.error("Cannot update person: Firestore db is not initialized");
                return;
            }
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const bcFamily = document.getElementById('edit-bcfamily').value;
            const ministry = document.getElementById('edit-ministry').value;
            const contactNumber = document.getElementById('edit-contactnumber').value;
            const ksaAddress = document.getElementById('edit-ksaaddress').value;
            const birthdate = document.getElementById('edit-birthdate').value;

            if (!name) {
                document.getElementById('edit-name-error').innerText = 'Name is required';
                return;
            }
            if (contactNumber && !/^\+?\d{10,15}$/.test(contactNumber)) {
                document.getElementById('edit-contactnumber-error').innerText = 'Invalid phone number';
                return;
            }
            if (!bcFamily) {
                document.getElementById('edit-bcfamily-error').innerText = 'BC Family is required';
                return;
            }
            if (!ministry) {
                document.getElementById('edit-ministry-error').innerText = 'Ministry is required';
                return;
            }

            const person = {
                Name: name.toLowerCase(),
                DisplayName: name,
                BCFamily: bcFamily,
                Ministry: ministry,
                ContactNumber: contactNumber,
                KSAAddress: ksaAddress,
                Birthdate: birthdate ? new Date(birthdate) : null
            };

            db.collection('people').doc(id).update(person).then(() => {
                $('#editModal').modal('hide');
                document.getElementById('edit-name-error').innerText = '';
                document.getElementById('edit-bcfamily-error').innerText = '';
                document.getElementById('edit-ministry-error').innerText = '';
                document.getElementById('edit-contactnumber-error').innerText = '';
                loadPeople();
            }).catch(error => {
                console.error("Error updating person:", error);
            });
        }

        function deletePerson(id) {
            if (!db) {
                console.error("Cannot delete person: Firestore db is not initialized");
                return;
            }
            if (confirm('Are you sure you want to delete this person?')) {
                db.collection('people').doc(id).delete().then(() => {
                    loadPeople();
                }).catch(error => {
                    console.error("Error deleting person:", error);
                });
            }
        }

        function openDetail(id) {
            alert('Detail view for ID: ' + id);
        }

        document.getElementById('search-form').addEventListener('submit', (e) => {
            e.preventDefault();
            searchTerm = document.getElementById('search-term').value;
            currentPage = 1;
            loadPeople();
        });

        document.getElementById('sort-name').addEventListener('click', (e) => {
            e.preventDefault();
            sortOrder = sortOrder === 'name_asc' ? 'name_desc' : 'name_asc';
            loadPeople();
        });
    </script>
}